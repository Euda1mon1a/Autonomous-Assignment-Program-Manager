# CP-SAT Canonical Schedule Generation (Block 10 / Half-Day Pipeline)

This document explains every Python file involved in schedule generation for Block 10 in the current CP-SAT-only pathway. The goal is simple:

- Preloaded things are preloaded. (Locked, never overwritten)
- Manual edits are manual. (Locked, never overwritten)
- Everything else is solved via CP-SAT.

If you only read one file, start with `backend/app/scheduling/engine.py`.

---

## 1) Entry Points (API + Orchestrator)

### `backend/app/api/routes/schedule.py`
- What it does: API endpoint for schedule generation.
- Role in pipeline: Builds the `SchedulingEngine` and calls `engine.generate(...)`.
- Important detail: The request `algorithm` is still accepted, but the engine now overrides to CP-SAT (canonical path).

### `backend/app/autonomous/generator.py`
- What it does: Candidate generator for autonomous workflows.
- Role in pipeline: Uses `SchedulingEngine._run_solver()` directly (not full pipeline).
- Canonical note: `_run_solver()` now forces CP-SAT regardless of algorithm, so this path is also CP-SAT only.

---

## 2) Core Orchestration (Single Source of Truth)

### `backend/app/scheduling/engine.py`
- What it does: The full orchestration pipeline. This file is the authoritative order of operations.
- Key responsibilities:
  - Loads/locks preloads
  - Expands block assignments to half-day slots
  - Builds `SchedulingContext`
  - Runs CP-SAT for call assignments (Sun-Thu)
  - Syncs PCAT/DO after call
  - Runs CP-SAT activity solver for unlocked resident slots
  - Runs CP-SAT faculty AT/C solver and fills remaining faculty slots
  - Validates and persists

Canonical CP-SAT enforcement:
- `generate()` forces `algorithm = "cp_sat"`.
- `_run_solver()` also forces CP-SAT for any caller.

Block 10 (half-day mode) flow:
1. Preloads (locked): `SyncPreloadService.load_all_preloads()`
2. Expand rotations: `BlockAssignmentExpansionService.expand_block_assignments()`
3. Build context: `SchedulingContext` (constraints, availability, etc.)
4. CP-SAT call solve: `CPSATSolver` returns `call_assignments`
5. Sync PCAT/DO: `engine._sync_call_pcat_do_to_half_day()`
6. CP-SAT activity solve: `CPSATActivitySolver`
7. CP-SAT faculty AT/C: `FacultyAssignmentExpansionService.fill_faculty_assignments()`
8. Validation + commit

---

## 3) Data Models That Define "Locked vs Solved"

### `backend/app/models/half_day_assignment.py`
- What it does: The authoritative daily AM/PM schedule table.
- Source priority system:
  1. `preload` (locked)
  2. `manual` (locked)
  3. `solver` (CP-SAT)
  4. `template` (lowest priority)
- Why it matters: All solver logic respects this source priority. Anything marked `preload` or `manual` is excluded from solver modifications.

### `backend/app/utils/activity_locking.py`
- What it does: Central list of preloaded/protected activity codes.
- Role: Used by expansion + activity solver to lock those activities.

---

## 4) Preload Pipeline (Locked Assignments)

### `backend/app/services/sync_preload_service.py`
- What it does: Synchronously loads locked preloads into `half_day_assignments`.
- Examples: FMIT, NF, absences, LV, PCAT/DO, conferences, SIM, TDY, etc.
- Critical flag: `skip_faculty_call=True` (engine) avoids using stale call data.
  - New call assignments are generated by CP-SAT later; PCAT/DO is synced from those.

---

## 5) Block Assignment Expansion (Template -> Daily Slots)

### `backend/app/services/block_assignment_expansion_service.py`
- What it does: Expands `BlockAssignment` rotations into daily AM/PM half-day slots.
- Where it writes: `half_day_assignments` (source=`solver` unless locked).
- Key behaviors:
  - Applies weekly patterns (from `RotationTemplate.weekly_patterns`)
  - Handles night float, off-site rotations, mid-block transitions
  - Applies 1-in-7 logic and weekend rules
  - Respects locked activities (`is_activity_preloaded`) while writing

---

## 6) Scheduling Context + Constraint Registry

### `backend/app/scheduling/constraints/base.py`
- What it does: Defines `SchedulingContext` (indices, availability, templates, call-eligible faculty, etc.).
- Why it matters: All CP-SAT constraints consume this context.

### `backend/app/scheduling/constraints/manager.py`
- What it does: Registers all enabled constraints for CP-SAT.
- Canonical call coverage:
  - `OvernightCallCoverageConstraint`
  - `AdjunctCallExclusionConstraint`
  - `CallAvailabilityConstraint`
- Call equity soft constraints:
  - `SundayCallEquityConstraint`
  - `WeekdayCallEquityConstraint`
  - `CallSpacingConstraint`
  - `TuesdayCallPreferenceConstraint`

---

## 7) CP-SAT Solver (Core Optimization)

### `backend/app/scheduling/solvers.py`
- What it does: Implements `CPSATSolver`, `SolverFactory`.
- In half-day mode: Only the call assignments are used; rotation assignments are discarded.
- Important logic:
  - Builds call variables for call-eligible faculty
  - Applies constraint set from `ConstraintManager`
  - Objective includes coverage + equity + all objective_terms
    - Call equity uses objective_terms

---

## 8) Call Constraints (Coverage + Equity)

### `backend/app/scheduling/constraints/call_coverage.py`
- What it does: Hard constraints to ensure exactly one call per Sun-Thu night.
- Also enforces:
  - Adjunct exclusion
  - Call availability (respect absences)

### `backend/app/scheduling/constraints/call_equity.py`
- What it does: Soft constraints to distribute call fairly.
- Now uses correct call-eligible indices, so it actually affects CP-SAT objective.

---

## 9) Call Sync -> PCAT/DO

### `backend/app/scheduling/engine.py` (Step 6.6)
- What it does: Converts solver call results into `CallAssignment` records.
- Then syncs PCAT/DO into `half_day_assignments` (source=`preload`).
- Why: PCAT counts toward supervision/AT coverage in later steps.

---

## 10) Activity Solver (CP-SAT)

### `backend/app/scheduling/activity_solver.py`
- What it does: Assigns C / LEC / ADV to unlocked resident half-day slots.
- Locked slots excluded: `source in {preload, manual}`
- Rules enforced: Wednesday LEC rules, last Wednesday ADV, physical capacity.

---

## 11) Faculty Expansion + CP-SAT AT/C

### `backend/app/services/faculty_assignment_expansion_service.py`
- What it does: Ensures all faculty have 56 half-day slots filled.
- CP-SAT step: `_solve_faculty_clinic_and_at()` assigns AT + Clinic slots.
- Fallback removed: OR-Tools is required (no greedy fallback).

---

## 12) Validation & Audits

### `backend/app/scheduling/validator.py`
- What it does: ACGME validation of the final schedule.

### `backend/app/scheduling/pre_solver_validator.py`
- What it does: Pre-solver saturation checks (fail fast if infeasible).

### `backend/app/scheduling/engine.py` (NF -> PC audit)
- What it does: Ensures post-call coverage after Night Float.

---

## 13) What Is Not Canonical Right Now (Archived)

The following solver paths are non-canonical in 2026-01 and should not be relied upon:

- Greedy solver: `backend/app/scheduling/solvers.py` (non-canonical)
- PuLP solver: `backend/app/scheduling/solvers.py` (non-canonical)
- Hybrid solver: `backend/app/scheduling/solvers.py` (non-canonical)
- Quantum/qubo solver stack: `backend/app/scheduling/quantum/*` (non-canonical)

See archive note: `docs/archived/unused-infrastructure/solver_paths_noncanonical.md`.

---

## 14) Known Gaps (Explicit)

- `RotationActivityRequirement` is loaded into `SchedulingContext` but not yet enforced by `CPSATActivitySolver` (documented to address later).
- `OvernightCallGenerationConstraint` exists but is disabled because call variables are already created in `CPSATSolver`.

---

## TL;DR Pipeline Summary

1. Load preloads (locked) -> `SyncPreloadService`
2. Expand block rotations -> `BlockAssignmentExpansionService`
3. CP-SAT call solve -> `CPSATSolver` + call constraints
4. Sync PCAT/DO -> `engine._sync_call_pcat_do_to_half_day()`
5. CP-SAT activities -> `CPSATActivitySolver`
6. CP-SAT faculty AT/C -> `FacultyAssignmentExpansionService`
7. Validate & commit -> `ACGMEValidator`

Everything not preloaded/manual is now CP-SAT.
