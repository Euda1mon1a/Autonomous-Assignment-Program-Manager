# PD Block Scheduling Readiness Review (Backend)

**Audience:** Program Director / Coordinator who uses the GUI but not the code.

**Question answered:** Can the backend generate a full block schedule in one shot and then support edits? What breaks, and what is missing?

---

## Executive Summary

**Answer:** The backend can generate a full block schedule end-to-end for typical use, and it has a draft-based edit/publish workflow. It does **not** yet cover every scenario and edge case a PD will hit without additional guardrails and UI wiring. The biggest gaps are around **export row mapping enforcement** and **GUI wiring for draft edits**. Several edge cases (block 13 length, call edits â†’ PCAT/DO, missing activity mappings) can also produce silent holes unless we add explicit checks.

---

## How the backend works today (short version)

**Generate a block**
1) Preloads: absences + inpatient preloads + call preloads + rotation-protected patterns (LEC/ADV, intern continuity, night-float/off-site). (`backend/app/services/preload_service.py`, `backend/app/services/sync_preload_service.py`)
2) CP-SAT solver produces block + call assignments. (`backend/app/scheduling/engine.py`, `backend/app/scheduling/solvers.py`)
3) Post-call and activity solver fill unlocked half-day slots. (`backend/app/scheduling/activity_solver.py`)
4) Export canonical JSON â†’ XLSX. (`backend/app/services/canonical_schedule_export_service.py`, `backend/app/services/json_to_xlsx_converter.py`)

**Edit a block**
- Use schedule drafts: add/modify/delete halfâ€‘day assignments in a draft, preview, publish, rollback. (`backend/app/api/routes/schedule_drafts.py`, `backend/app/services/schedule_draft_service.py`)

---

## Readiness Matrix â€” normal + edge + edge-of-edge

**Legend**
- âœ… Supported
- ğŸŸ¡ Partial / requires manual steps
- âŒ Missing or unsafe

### A) Inputs & setup (pre-solve)
- âœ… People/roles exist (residents/faculty). (`backend/app/models/person.py`)
- âœ… Rotation templates (primary + secondary mid-block). (`backend/app/models/rotation_template.py`, `backend/app/models/block_assignment.py`)
- âœ… Block assignments import (CSV/Excel). (`backend/app/services/block_assignment_import_service.py`)
- âœ… Absences (blocking). (`backend/app/services/preload_service.py`)
- âœ… Inpatient preloads for FMIT/NF/PedW/KAP/IM/LDNF. (`backend/app/models/inpatient_preload.py`, `backend/app/services/preload_service.py`)
- âœ… Resident call preloads. (`backend/app/models/resident_call_preload.py`, `backend/app/services/preload_service.py`)
- âœ… Activity requirements with default fallback for outpatient. (`backend/app/scheduling/activity_solver.py`)
- âœ… Conference/protected time handled **manually** (not auto-preloaded by design).
- ğŸŸ¡ Activity codes missing â†’ preload skipped (logs only). (`backend/app/services/preload_service.py`)

### B) Generation (CP-SAT)
- âœ… Canonical CP-SAT pipeline enforced. (`docs/scheduling/CP_SAT_CANONICAL_PIPELINE.md`, `backend/app/scheduling/engine.py`)
- âœ… Call coverage for Sunâ€“Thu generated by solver. (`backend/app/scheduling/constraints/*call*`, `backend/app/scheduling/engine.py`)
- âœ… Fri/Sat call handled via FMIT preloads. (`backend/app/services/preload_service.py`)
- âœ… Manual/preload slots are preserved during re-gen; solver/template slots are cleared. (`backend/app/scheduling/engine.py`)
- ğŸŸ¡ Algorithm parameter accepted but overridden to CP-SAT; UI may mislead. (`backend/app/api/routes/schedule.py`, `backend/app/scheduling/engine.py`)
- âœ… Block 0 supported in half-day list endpoint (0â€“13).

### C) Protected patterns (rotation rules)
- âœ… Wednesday PM LEC for most rotations. (`backend/app/services/preload_service.py`)
- âœ… Last Wednesday AM/PM LEC/ADV for all. (`backend/app/services/preload_service.py`)
- âœ… Intern continuity Wed AM (PGYâ€‘1) except exempt rotations. (`backend/app/services/preload_service.py`)
- âœ… Kapiolani (KAP) pattern. (`backend/app/services/preload_service.py`)
- âœ… LDNF Friday clinic + weekday OFF/LDNF. (`backend/app/services/preload_service.py`)
- âœ… NF/PedNF weekday OFF/NF + weekend W. (`backend/app/services/preload_service.py`)
- âœ… Hilo/OKI TDY with pre/post clinic days. (`backend/app/services/preload_service.py`)
- ğŸŸ¡ Compound rotation weekend rules depend on rotation name parsing; works for common patterns but fragile to naming variants. (`backend/app/services/sync_preload_service.py`)

### D) Post-call rules
- âœ… PCAT/DO created for faculty call (Sunâ€“Thu) via preload sync. (`backend/app/services/sync_preload_service.py`, `backend/app/services/call_assignment_service.py`)
- âœ… Call assignments API supports edits + PCAT/DO regen. (`backend/app/api/routes/call_assignments.py`)
- ğŸŸ¡ Manual call edits do **not** auto-sync PCAT/DO unless the endpoint is used. (`backend/app/api/routes/call_assignments.py`)

### E) Editing workflow
- âœ… Draft workflow: create, preview, publish, rollback within 24h. (`backend/app/api/routes/schedule_drafts.py`)
- âœ… Drafts write to half_day_assignments as MANUAL. (`backend/app/services/schedule_draft_service.py`)
- ğŸŸ¡ Drafts **do not override** preloads/manual slots on ADD (locked by source). Must DELETE first. (`backend/app/services/schedule_draft_service.py`)
- ğŸŸ¡ No direct half-day assignment edit endpoint (drafts only). (`backend/app/api/routes/half_day_assignments.py`)
- ğŸŸ¡ GUI wiring for drafts is still in progress (backend ready, frontend TBD). (`frontend/*` not wired yet)

### F) Export
- âœ… Canonical JSON export reads half_day_assignments. (`backend/app/services/half_day_json_exporter.py`)
- âœ… JSON â†’ XLSX conversion for Template2. (`backend/app/services/json_to_xlsx_converter.py`)
- âœ… Strict row mapping enforcement (missing row -> explicit error). (`backend/app/services/xml_to_xlsx_converter.py`)
- ğŸŸ¡ Export UI auth wiring in frontend still pending. (`frontend/src/lib/export.ts`)

### G) Edge cases (edge-of-edge)
- ğŸŸ¡ Block 13 (variable length): rules use block_end; patterns should still apply but not explicitly tested. (`backend/app/utils/academic_blocks.py`)
- ğŸŸ¡ Hilo/OKI day-index logic assumes standard 28â€‘day blocks; nonstandard blocks could misalign. (`backend/app/services/preload_service.py`)
- ğŸŸ¡ Re-run solver after manual edits: manual slots preserved, but any solver/template slots are wiped; must communicate to users. (`backend/app/scheduling/engine.py`)
- ğŸŸ¡ Missing activity mappings â†’ preloads skipped (logs only). No hard failure. (`backend/app/services/preload_service.py`)

---

## Findings (what prevents â€œevery possible scenarioâ€)

**P0 â€” Functional gaps**
1) **Export UI still needs auth wiring + error handling.** (`frontend/src/lib/export.ts`)

**P1 â€” Editing caveats**
2) **Draft edits do not override preloads by default.** Add/update skips if existing source is PRELOAD or MANUAL; users must delete first. This is correct for safety but needs GUI messaging. (`backend/app/services/schedule_draft_service.py`)

3) **Call edits require explicit PCAT/DO regeneration.** Manual call updates wonâ€™t automatically update post-call time unless the dedicated endpoint is used. (`backend/app/api/routes/call_assignments.py`)

**P2 â€” Edge-case coverage**
4) **Compound rotation parsing is fragile.** It handles common patterns but depends on rotation naming conventions that may drift. (`backend/app/services/sync_preload_service.py`)

---

## Implementation Plan (phased)

### Phase 1 â€” PD-safe generation + export (P0)
1) **Export UX + error handling**
   - Ensure export uses authenticated call.
   - Surface missing mapping / backend errors in UI.
   - Files: `frontend/src/lib/export.ts`

### Phase 2 â€” PD-safe editing (P1)
2) **Draft override UX / API affordances**
   - Add explicit â€œoverride preloadâ€ change type or confirm-delete flow.
   - Surface locked/preload reasons in draft preview.
   - Files: `backend/app/services/schedule_draft_service.py`, `backend/app/api/routes/schedule_drafts.py`

3) **Call edit + PCAT/DO sync**
   - Offer optional `auto_generate_post_call=true` on call update endpoints.
   - Files: `backend/app/api/routes/call_assignments.py`, `backend/app/services/call_assignment_service.py`

### Phase 3 â€” Edge-case hardening (P2)
4) **Compound rotation normalization**
   - Centralize rotation code normalization and move to data-driven mapping.
   - Add tests for naming variants.
   - Files: `backend/app/services/sync_preload_service.py`, `backend/app/services/preload_service.py`

---

## Suggested acceptance tests (backend)

- Generate Block N with representative inputs; confirm:
  - LEC/ADV on last Wednesday
  - Intern Wed AM continuity
  - KAP, LDNF, NF, PedNF patterns
  - Hilo/OKI pre/post clinic days
- Export JSON + XLSX; verify all mapped people present and failures are explicit.
- Draft edit on a preload slot: verify deleteâ€‘thenâ€‘add path works and is visible.
- Call edit: verify PCAT/DO regen works and is required.

---

## PD workflow (ideal endâ€‘state)

1) Upload/confirm block assignments + absences + inpatient preloads
2) Generate block schedule (CPâ€‘SAT)
3) Review in GUI (halfâ€‘day assignments)
4) Make edits via drafts â†’ preview â†’ publish
5) Export canonical JSON/XLSX

---

If you want, I can turn the Phase 1â€“3 items into specific tickets with owners and PR scopes.
