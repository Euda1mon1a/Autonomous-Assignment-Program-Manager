# Migration Procedures Guide

> **Status:** Complete migration workflow documentation
> **Last Updated:** 2025-12-31

## Table of Contents

1. [Overview](#overview)
2. [Migration Types](#migration-types)
3. [Creating Migrations](#creating-migrations)
4. [Applying Migrations](#applying-migrations)
5. [Rolling Back Migrations](#rolling-back-migrations)
6. [Testing Migrations](#testing-migrations)
7. [Common Patterns](#common-patterns)
8. [Troubleshooting](#troubleshooting)
9. [CI/CD Integration](#cicd-integration)

---

## Overview

Migrations manage database schema changes using Alembic. They:
- Track database evolution
- Enable rollback capability
- Maintain production safety
- Provide version control for schema

### Key Principles

1. **One migration per logical change**: Don't combine unrelated changes
2. **Backward compatibility**: Old code should work during gradual rollout
3. **Reviewable migrations**: Keep them readable for code review
4. **Tested rollbacks**: Always test `downgrade` works
5. **Data safety**: Plan for data migrations carefully

### Architecture

```
Models (SQLAlchemy)
    ↓
Migrations (Alembic)
    ↓
Database Schema
```

---

## Migration Types

### 1. Schema Migrations (Autogenerated)

Structural changes detected and generated automatically.

**Examples**:
- Add/remove columns
- Add/remove tables
- Change column types
- Add/remove constraints
- Add/remove indexes

**Generation**:
```bash
cd backend
alembic revision --autogenerate -m "Add email column to persons"
```

### 2. Data Migrations (Manual)

Application-level data transformations.

**Examples**:
- Populate new columns from existing data
- Rename values in enum columns
- Merge/split columns
- Denormalize for performance

**Template**:
```python
"""Data migration: Rename role values."""

from alembic import op
import sqlalchemy as sa


def upgrade() -> None:
    """Upgrade: Rename OLD_ROLE to NEW_ROLE."""
    op.execute(
        "UPDATE persons SET role = 'NEW_ROLE' WHERE role = 'OLD_ROLE'"
    )


def downgrade() -> None:
    """Downgrade: Restore original role values."""
    op.execute(
        "UPDATE persons SET role = 'OLD_ROLE' WHERE role = 'NEW_ROLE'"
    )
```

### 3. Complex Migrations

Multi-step migrations requiring orchestration.

**Example**: Add new table with foreign keys from existing table

```python
"""Add certifications table."""

from alembic import op
import sqlalchemy as sa


def upgrade() -> None:
    """Create certifications table with proper constraints."""
    # Step 1: Create table
    op.create_table(
        'certifications',
        sa.Column('id', sa.String(36), primary_key=True),
        sa.Column('person_id', sa.String(36), sa.ForeignKey('persons.id')),
        sa.Column('name', sa.String(255), nullable=False),
        sa.Column('expires_at', sa.DateTime),
    )

    # Step 2: Create index
    op.create_index('ix_certifications_person_id', 'certifications', ['person_id'])

    # Step 3: Add constraint
    op.create_unique_constraint(
        'uq_certifications_person_name',
        'certifications',
        ['person_id', 'name']
    )


def downgrade() -> None:
    """Remove certifications table."""
    op.drop_table('certifications')
```

---

## Creating Migrations

### Step 1: Modify Model

Edit the SQLAlchemy model in `backend/app/models/`:

```python
# backend/app/models/person.py
from sqlalchemy import Column, String, DateTime

class Person(Base):
    __tablename__ = "persons"

    id = Column(String(36), primary_key=True)
    name = Column(String(255), nullable=False)
    email = Column(String(255))  # NEW COLUMN
    created_at = Column(DateTime, default=datetime.utcnow)
```

### Step 2: Generate Migration

```bash
cd backend
alembic revision --autogenerate -m "Add email column to persons"
```

This creates `alembic/versions/abc123_add_email_column_to_persons.py`

### Step 3: Review Migration

**ALWAYS** review autogenerated migrations - they're not perfect!

```python
# alembic/versions/abc123_add_email_column_to_persons.py
def upgrade() -> None:
    op.add_column('persons', sa.Column('email', sa.String(255), nullable=True))


def downgrade() -> None:
    op.drop_column('persons', 'email')
```

**Check for**:
- Correctness of column definitions
- Missing constraints
- Nullable vs NOT NULL
- Indexes needed
- Foreign keys
- Unique constraints

### Step 4: Edit if Needed

```python
# Enhanced version
def upgrade() -> None:
    # Add column with constraint
    op.add_column(
        'persons',
        sa.Column('email', sa.String(255), nullable=False, unique=True)
    )

    # Create index for frequent queries
    op.create_index('ix_persons_email', 'persons', ['email'])


def downgrade() -> None:
    op.drop_index('ix_persons_email')
    op.drop_column('persons', 'email')
```

### Step 5: Test Locally

```bash
# Apply migration
alembic upgrade head

# Verify schema
python -c "from app.db.session import engine; \
from app.db.base import Base; \
from app.models import *; \
from sqlalchemy import inspect; \
inspector = inspect(engine); \
print(inspector.get_columns('persons'))"

# Test rollback
alembic downgrade -1

# Re-apply
alembic upgrade head
```

### Step 6: Commit

```bash
git add alembic/versions/abc123_add_email_column_to_persons.py
git commit -m "migration: Add email column to persons table"
```

---

## Applying Migrations

### Development

```bash
cd backend

# Apply all pending migrations
alembic upgrade head

# Apply specific migration
alembic upgrade abc123

# Apply one migration
alembic upgrade +1
```

### Production (Careful!)

**Always backup first**:
```bash
# Backup PostgreSQL
pg_dump -h $DB_HOST -U $DB_USER $DB_NAME > backup_before_migration.sql

# Backup SQLite (if used)
cp residency_scheduler.db residency_scheduler.db.backup
```

**Apply migrations**:
```bash
cd backend
alembic upgrade head
```

**Verify**:
```python
# Check current revision
alembic current

# Show history
alembic history
```

### Staged Rollout (Recommended)

1. **Development**: Test migration with dev data
2. **Staging**: Test with production-like data
3. **Blue-Green**: Run alongside old version
4. **Canary**: 10% of production
5. **Full Rollout**: Remaining 90%

---

## Rolling Back Migrations

### Quick Rollback

```bash
cd backend

# Rollback one migration
alembic downgrade -1

# Rollback multiple
alembic downgrade -3

# Rollback to specific revision
alembic downgrade abc123
```

### Emergency Rollback (Production)

```bash
# List history
alembic history

# Show current
alembic current

# Rollback to known good state
alembic downgrade xyz789

# Verify
alembic current
```

**Critical**: Test downgrade functionality before deploying upgrades.

---

## Testing Migrations

### Dry Run (Show SQL)

```bash
# Show SQL for upgrade
alembic upgrade --sql head

# Show SQL for downgrade
alembic downgrade --sql -1

# Show all changes
alembic history --verbose
```

### Test Database

Create test database for safe testing:

```bash
# Create test copy
createdb -T residency_scheduler residency_scheduler_test

# Run migrations on test
alembic -x sqlalchemy.url=postgresql://user:pass@localhost/residency_scheduler_test upgrade head

# Run downgrade
alembic -x sqlalchemy.url=postgresql://user:pass@localhost/residency_scheduler_test downgrade -1

# Drop test database
dropdb residency_scheduler_test
```

### Validation Script

```python
# test_migration.py
from sqlalchemy import inspect, create_engine
from app.db.base import Base

def test_migration():
    """Test migration applied correctly."""
    engine = create_engine("postgresql://...")
    inspector = inspect(engine)

    # Check table exists
    assert 'persons' in inspector.get_table_names()

    # Check column exists
    columns = [c['name'] for c in inspector.get_columns('persons')]
    assert 'email' in columns

    # Check column type
    email_col = next(c for c in inspector.get_columns('persons')
                     if c['name'] == 'email')
    assert email_col['type'].__class__.__name__ == 'String'

    print("✓ Migration validation passed")

if __name__ == "__main__":
    test_migration()
```

---

## Common Patterns

### Pattern 1: Add New Column with Default

```python
def upgrade() -> None:
    """Add status column with default."""
    op.add_column(
        'assignments',
        sa.Column(
            'status',
            sa.String(50),
            nullable=False,
            server_default='ACTIVE'
        )
    )


def downgrade() -> None:
    op.drop_column('assignments', 'status')
```

### Pattern 2: Rename Column

```python
def upgrade() -> None:
    """Rename created_at to created_timestamp."""
    op.alter_column(
        'persons',
        'created_at',
        new_column_name='created_timestamp'
    )


def downgrade() -> None:
    op.alter_column(
        'persons',
        'created_timestamp',
        new_column_name='created_at'
    )
```

### Pattern 3: Add Foreign Key

```python
def upgrade() -> None:
    """Add foreign key to assignments."""
    op.create_foreign_key(
        'fk_assignments_person_id',
        'assignments',
        'persons',
        ['person_id'],
        ['id']
    )


def downgrade() -> None:
    op.drop_constraint(
        'fk_assignments_person_id',
        'assignments',
        type_='foreignkey'
    )
```

### Pattern 4: Create Index

```python
def upgrade() -> None:
    """Create index for performance."""
    op.create_index(
        'ix_assignments_person_date',
        'assignments',
        ['person_id', 'date']
    )


def downgrade() -> None:
    op.drop_index('ix_assignments_person_date')
```

### Pattern 5: Data Migration with Condition

```python
def upgrade() -> None:
    """Populate new column from existing data."""
    op.execute(
        """
        UPDATE persons
        SET employment_type = 'FULL_TIME'
        WHERE is_active = TRUE
        """
    )


def downgrade() -> None:
    op.execute(
        """
        UPDATE persons
        SET employment_type = NULL
        """
    )
```

---

## Troubleshooting

### Issue: "No such table" errors

**Cause**: Running app code before migrations applied

**Solution**:
```bash
alembic upgrade head
python app/main.py
```

### Issue: "Foreign key constraint fails"

**Cause**: Dropping table while other tables reference it

**Solution**:
```python
# Drop dependent tables first
def upgrade():
    op.drop_table('assignments')
    op.drop_table('persons')
```

### Issue: Alembic can't find changes

**Cause**: SQLAlchemy model not imported properly

**Solution**:
1. Check imports in `alembic/env.py`
2. Ensure all models imported in `app/models/__init__.py`
3. Verify `target_metadata` is correct

```python
# alembic/env.py
from app.db.base import Base
from app.models import *  # Import all models

target_metadata = Base.metadata
```

### Issue: "Current database version has no target revision"

**Cause**: Database not initialized

**Solution**:
```bash
alembic upgrade head
```

### Issue: Migrations keep failing in test

**Cause**: Test database not properly isolated

**Solution**:
```python
# conftest.py
@pytest.fixture
def db():
    """Fresh database for each test."""
    Base.metadata.create_all(engine)
    yield SessionLocal()
    Base.metadata.drop_all(engine)
```

---

## CI/CD Integration

### GitHub Actions Example

```yaml
# .github/workflows/migrations.yml
name: Test Migrations

on: [push, pull_request]

jobs:
  test-migrations:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Validate migrations
        run: |
          cd backend
          python scripts/migration_utils.py validate

      - name: Test upgrade
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost/test_db
        run: |
          cd backend
          alembic upgrade head

      - name: Test downgrade
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost/test_db
        run: |
          cd backend
          alembic downgrade base

      - name: Show history
        run: |
          cd backend
          alembic history --verbose
```

### Pre-deployment Checks

```bash
#!/bin/bash
# scripts/pre-migration-check.sh

set -e

echo "Checking migrations..."
cd backend

# Validate syntax
python scripts/migration_utils.py validate || exit 1

# Check for conflicts
python scripts/migration_utils.py conflicts || exit 1

# Show what would be applied
alembic upgrade --sql head

echo "✓ All pre-migration checks passed"
```

---

## Migration Workflow Summary

```
┌─────────────────────────────┐
│ Modify SQLAlchemy Model     │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ Generate Migration          │
│ (alembic revision ...)      │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ Review Generated Migration  │
│ (check alembic/versions/)   │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ Test Locally                │
│ (upgrade head, downgrade -1)│
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ Commit                      │
│ (git add & git commit)      │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ Test in Staging             │
│ (full upgrade + downgrade)  │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ Deploy & Migrate            │
│ (alembic upgrade head)      │
└─────────────────────────────┘
```

---

## Checklist: Before Deploying Migration

- [ ] Model change committed
- [ ] Migration generated and reviewed
- [ ] Migration file added to git
- [ ] Tested upgrade locally
- [ ] Tested downgrade locally
- [ ] No manual edits needed (if so, documented)
- [ ] Backward compatibility verified
- [ ] Database backup taken
- [ ] Staging migration successful
- [ ] Performance impact assessed
- [ ] Rollback plan documented
- [ ] Team notified

---

## Summary

| Task | Command |
|------|---------|
| Generate | `alembic revision --autogenerate -m "message"` |
| Apply All | `alembic upgrade head` |
| Apply One | `alembic upgrade +1` |
| Rollback One | `alembic downgrade -1` |
| Show Current | `alembic current` |
| Show History | `alembic history` |
| Validate | `python scripts/migration_utils.py validate` |
| Dry Run | `alembic upgrade --sql head` |

---

*This guide should be updated as new migration patterns are discovered.*
