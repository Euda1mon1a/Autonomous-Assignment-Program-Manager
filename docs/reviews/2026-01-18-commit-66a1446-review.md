# Commit 66a1446 Review (feature flags + schedule restore)

## Findings (ordered by severity)

- High: Feature-flagged exotic resilience endpoints are likely unreachable for all users because the decorator pulls `current_user` from kwargs and the endpoints do not inject it; role targeting then fails when `user_role` is None. Evidence: `backend/app/api/routes/exotic_resilience.py:525` (no `current_user`), `backend/app/features/decorators.py:49`, `backend/app/features/evaluator.py:150`. Impact: admin-only flag (`exotic_resilience_enabled`) will always 404. Fix: add `current_user: User = Depends(get_current_active_user)` to these routes or relax role targeting for this flag.

- Medium: `seed_feature_flags.py` hard-codes a non-default admin password, so a fresh DEBUG instance (default password `admin123`) will fail to seed flags unless the password was changed. Evidence: `scripts/seed_feature_flags.py:115`, `backend/app/main.py:123`. Impact: seed script fails out of the box, creating a false sense that flags were created. Fix: read credentials from env or support a fallback list.

- Medium: `_find_existing_assignments` can return duplicate assignments when `time_of_day="ALL"` and only one half-day exists; the fallback query re-adds the already found assignment, leading to duplicate backups. Evidence: `backend/app/scheduling/schedule_publish_staging.py:268`, `backend/app/scheduling/schedule_publish_staging.py:306`, `backend/app/scheduling/schedule_publish_staging.py:218`. Impact: duplicate backups and potential duplicate restores. Fix: dedupe results by ID or reset `results` before fallback.

- Low: `updated_at` is serialized but never restored, which weakens audit fidelity after rollback. Evidence: `backend/app/scheduling/schedule_publish_staging.py:340`, `backend/app/scheduling/schedule_publish_staging.py:488`. Impact: restored rows lose original update timestamps. Fix: restore `updated_at` or remove it from backup payloads to avoid false precision.

## Systemic/architecture gaps

- Feature flag gating assumes every gated endpoint injects a user dependency; this implicit contract is not enforced, so any unauthenticated or internal route will silently fail role checks.
- Flag seeding is a one-off HTTP script that depends on a running API and local credentials; there is no migration/startup hook to guarantee flags exist across environments.

## Scope notes

- This commit does not touch the /admin UI, lab navigation, dynamic imports, or deleted routes. The earlier frontend concerns (lazy loading, route consolidation, Labs nav structure, shared components, stigmergy-flow placement) remain unreviewed here.

## Testing gaps

- No tests added for full-day backup/restore correctness or feature-flag gating behavior. Consider targeted integration tests around `backend/app/scheduling/schedule_publish_staging.py` and `backend/app/api/routes/exotic_resilience.py`.
