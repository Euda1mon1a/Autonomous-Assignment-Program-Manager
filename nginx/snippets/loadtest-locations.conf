# =============================================================================
# Load Testing Location Blocks - Include in Server Block
# =============================================================================
# These locations provide relaxed rate limits for authorized load testing.
# Include this file in your server block in conf.d/default.conf:
#
#   server {
#       ...
#       include /etc/nginx/snippets/loadtest-locations.conf;
#       ...
#   }
#
# SECURITY: Requires load-testing.conf to be loaded (defines $load_test_mode)
# =============================================================================

# -----------------------------------------------------------------------------
# Load Test API Endpoints (Relaxed Rate Limits)
# -----------------------------------------------------------------------------
location /api/loadtest/ {
    # SECURITY: Require both whitelisted IP AND valid load test key
    if ($load_test_whitelist = 0) {
        return 403 '{"error":"Load testing not allowed from this IP"}';
    }

    if ($load_test_mode = 0) {
        return 403 '{"error":"Valid X-Load-Test-Key header required"}';
    }

    # Relaxed rate limiting for load tests (100 req/s vs 30 req/s normal)
    limit_req zone=loadtest_api burst=200 nodelay;
    limit_conn conn_limit 50;

    # Use enhanced upstream with connection pooling
    proxy_pass http://backend_loadtest;
    include /etc/nginx/snippets/proxy-params.conf;

    # Enhanced timeouts for load testing
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Enhanced buffers for high throughput
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Detailed logging for analysis
    access_log /var/log/nginx/loadtest.log loadtest;

    # Identifier header
    add_header X-Load-Test-Mode "active" always;
}

# -----------------------------------------------------------------------------
# Load Test Schedule Generation (Most Resource-Intensive)
# -----------------------------------------------------------------------------
location /api/loadtest/schedule/generate {
    # SECURITY: Require both whitelisted IP AND valid load test key
    if ($load_test_whitelist = 0) {
        return 403 '{"error":"Load testing not allowed from this IP"}';
    }

    if ($load_test_mode = 0) {
        return 403 '{"error":"Valid X-Load-Test-Key header required"}';
    }

    # Relaxed but controlled rate limiting (10 req/min vs 1 req/10s normal)
    limit_req zone=loadtest_schedule burst=5 nodelay;
    limit_conn conn_limit 10;

    # Use enhanced upstream
    proxy_pass http://backend_loadtest;
    include /etc/nginx/snippets/proxy-params.conf;

    # Very long timeouts for complex schedule generation
    proxy_connect_timeout 60s;
    proxy_send_timeout 600s;      # 10 minutes
    proxy_read_timeout 600s;       # 10 minutes

    # Large buffers for potentially large schedule responses
    proxy_buffer_size 256k;
    proxy_buffers 8 256k;
    proxy_busy_buffers_size 512k;

    # Detailed logging
    access_log /var/log/nginx/loadtest.log loadtest;

    add_header X-Load-Test-Mode "active" always;
}

# -----------------------------------------------------------------------------
# Load Test Metrics Endpoint
# -----------------------------------------------------------------------------
location /api/loadtest/metrics {
    # SECURITY: Require whitelist (no key needed for metrics)
    if ($load_test_whitelist = 0) {
        return 403;
    }

    # Minimal rate limiting for metrics endpoint
    limit_req zone=loadtest_general burst=50 nodelay;

    proxy_pass http://backend_loadtest/metrics;
    include /etc/nginx/snippets/proxy-params.conf;

    # Fast timeouts for metrics
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Don't log every metrics request (too noisy)
    access_log off;
}
