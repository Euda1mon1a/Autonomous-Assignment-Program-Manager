# =============================================================================
# Load Testing Configuration - Residency Scheduler
# =============================================================================
# Enhanced connection pooling, relaxed rate limits, and monitoring for
# authorized load testing. Maintains security while enabling performance testing.
# =============================================================================
#
# SECURITY NOTICE:
# - Load testing is restricted to whitelisted IPs and requires secret key
# - Replace YOUR_LOAD_TEST_SECRET_KEY with actual secret before deployment
# - Never expose load test endpoints to public internet
# - Monitor load test logs for unauthorized access attempts
#
# =============================================================================

# -----------------------------------------------------------------------------
# Load Test Authentication - Header-Based Activation
# -----------------------------------------------------------------------------
# Detects legitimate load testing via X-Load-Test-Key header
# Usage: Include header in load test requests: "X-Load-Test-Key: YOUR_SECRET"
map $http_x_load_test_key $load_test_mode {
    default 0;
    # SECURITY: Replace with actual secret key (min 32 chars)
    # Generate with: python -c 'import secrets; print(secrets.token_urlsafe(32))'
    "YOUR_LOAD_TEST_SECRET_KEY" 1;
}

# -----------------------------------------------------------------------------
# IP Whitelist for Load Testing
# -----------------------------------------------------------------------------
# Restrict load testing to trusted networks only
# Prevents external abuse of relaxed rate limits
geo $load_test_whitelist {
    default 0;

    # Localhost
    127.0.0.1/32 1;
    ::1/128 1;

    # Docker networks (default Docker bridge and user-defined networks)
    172.16.0.0/12 1;

    # Common private networks
    10.0.0.0/8 1;          # Class A private network
    192.168.0.0/16 1;      # Class C private network

    # Add CI/CD server IPs here:
    # 203.0.113.0/24 1;    # Example: Jenkins/GitLab CI runners
    # 198.51.100.50/32 1;  # Example: Specific load testing server
}

# -----------------------------------------------------------------------------
# Enhanced Rate Limiting Zones for Load Testing
# -----------------------------------------------------------------------------
# Relaxed limits for authorized load testing while preventing abuse

# Load test API rate limit - 100 requests/second per IP
# 100x more permissive than normal API rate limit (30r/s)
limit_req_zone $binary_remote_addr zone=loadtest_api:10m rate=100r/s;

# Load test schedule generation - 10 requests/minute per IP
# 100x more permissive than normal schedule gen (1r/10s)
limit_req_zone $binary_remote_addr zone=loadtest_schedule:10m rate=10r/m;

# Load test general endpoints - 50 requests/second per IP
# 5x more permissive than normal general rate (10r/s)
limit_req_zone $binary_remote_addr zone=loadtest_general:10m rate=50r/s;

# -----------------------------------------------------------------------------
# Enhanced Upstream for Load Testing
# -----------------------------------------------------------------------------
# Dedicated upstream pool with aggressive connection reuse
# Optimized for high-throughput load testing scenarios
upstream backend_loadtest {
    # Use least connections for even load distribution
    least_conn;

    # Primary backend server (same as production)
    server backend:8000 weight=5 max_fails=5 fail_timeout=10s;

    # Add additional backend servers for horizontal scaling during load tests:
    # server backend-2:8000 weight=5 max_fails=5 fail_timeout=10s;
    # server backend-3:8000 weight=5 max_fails=5 fail_timeout=10s;

    # ENHANCED CONNECTION POOLING
    # Keep 100 idle connections ready (vs 32 in normal upstream)
    keepalive 100;

    # Allow 10,000 requests per connection before closing (vs 1,000 normal)
    # Reduces connection overhead for high-volume testing
    keepalive_requests 10000;

    # Keep connections alive for 60 seconds
    keepalive_timeout 60s;
}

# -----------------------------------------------------------------------------
# Detailed Logging Format for Load Test Analysis
# -----------------------------------------------------------------------------
# Captures timing metrics essential for performance analysis
# Compatible with load testing tools (K6, JMeter, Locust, etc.)
log_format loadtest escape=json
    '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"request_protocol":"$server_protocol",'
        '"status":"$status",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"request_time":"$request_time",'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_status":"$upstream_status",'
        '"upstream_connect_time":"$upstream_connect_time",'
        '"upstream_header_time":"$upstream_header_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"http_x_load_test_key":"$http_x_load_test_key",'
        '"load_test_mode":"$load_test_mode",'
        '"connection":"$connection",'
        '"connection_requests":"$connection_requests"'
    '}';

# =============================================================================
# LOCATION BLOCKS FOR SERVER CONFIGURATION
# =============================================================================
# The following location blocks should be added to the server block in
# /etc/nginx/conf.d/default.conf for load testing support.
#
# Add these inside the "server" block (around line 30 in default.conf)
# =============================================================================

# -----------------------------------------------------------------------------
# EXAMPLE 1: Nginx Status Endpoint (Enhanced for Load Testing)
# -----------------------------------------------------------------------------
# NOTE: /nginx_status already exists in default.conf (line 154-162)
# No changes needed - already configured with proper IP restrictions
#
# If you need a separate load test status endpoint, add this:
#
# location /nginx_status_loadtest {
#     stub_status on;
#     access_log off;
#
#     # Restrict to whitelisted IPs only
#     allow 127.0.0.1;
#     allow 10.0.0.0/8;
#     allow 172.16.0.0/12;
#     allow 192.168.0.0/16;
#     deny all;
# }

# -----------------------------------------------------------------------------
# EXAMPLE 2: Load Test API Endpoints (Relaxed Rate Limits)
# -----------------------------------------------------------------------------
# Add this location block to default.conf for dedicated load testing routes
#
# location /api/loadtest/ {
#     # SECURITY: Require both whitelisted IP AND valid load test key
#     if ($load_test_whitelist = 0) {
#         return 403 '{"error":"Load testing not allowed from this IP"}';
#     }
#
#     if ($load_test_mode = 0) {
#         return 403 '{"error":"Valid X-Load-Test-Key header required"}';
#     }
#
#     # Relaxed rate limiting for load tests
#     limit_req zone=loadtest_api burst=200 nodelay;
#     limit_conn conn_limit 50;
#
#     # Use enhanced upstream with connection pooling
#     proxy_pass http://backend_loadtest;
#     include /etc/nginx/snippets/proxy-params.conf;
#
#     # ENHANCED TIMEOUTS for load testing
#     proxy_connect_timeout 60s;
#     proxy_send_timeout 300s;
#     proxy_read_timeout 300s;
#
#     # ENHANCED BUFFERS for high throughput
#     proxy_buffer_size 128k;
#     proxy_buffers 4 256k;
#     proxy_busy_buffers_size 256k;
#
#     # Detailed logging for analysis
#     access_log /var/log/nginx/loadtest.log loadtest;
#
#     # Add load test identifier to response
#     add_header X-Load-Test-Mode "active" always;
# }

# -----------------------------------------------------------------------------
# EXAMPLE 3: Load Test Schedule Generation (Most Resource-Intensive)
# -----------------------------------------------------------------------------
# Dedicated endpoint for testing schedule generation under load
#
# location /api/loadtest/schedule/generate {
#     # SECURITY: Require both whitelisted IP AND valid load test key
#     if ($load_test_whitelist = 0) {
#         return 403 '{"error":"Load testing not allowed from this IP"}';
#     }
#
#     if ($load_test_mode = 0) {
#         return 403 '{"error":"Valid X-Load-Test-Key header required"}';
#     }
#
#     # Relaxed but still controlled rate limiting (schedule gen is expensive)
#     limit_req zone=loadtest_schedule burst=5 nodelay;
#     limit_conn conn_limit 10;
#
#     # Use enhanced upstream
#     proxy_pass http://backend_loadtest;
#     include /etc/nginx/snippets/proxy-params.conf;
#
#     # VERY LONG TIMEOUTS for complex schedule generation
#     proxy_connect_timeout 60s;
#     proxy_send_timeout 600s;      # 10 minutes
#     proxy_read_timeout 600s;       # 10 minutes
#
#     # Large buffers for potentially large schedule responses
#     proxy_buffer_size 256k;
#     proxy_buffers 8 256k;
#     proxy_busy_buffers_size 512k;
#
#     # Detailed logging
#     access_log /var/log/nginx/loadtest.log loadtest;
#
#     add_header X-Load-Test-Mode "active" always;
# }

# -----------------------------------------------------------------------------
# EXAMPLE 4: Load Test Metrics Endpoint
# -----------------------------------------------------------------------------
# Expose real-time metrics during load testing
#
# location /api/loadtest/metrics {
#     # SECURITY: Require whitelist (no key needed for metrics)
#     if ($load_test_whitelist = 0) {
#         return 403;
#     }
#
#     # Minimal rate limiting for metrics endpoint
#     limit_req zone=loadtest_general burst=50 nodelay;
#
#     proxy_pass http://backend_loadtest/metrics;
#     include /etc/nginx/snippets/proxy-params.conf;
#
#     # Fast timeouts for metrics
#     proxy_connect_timeout 10s;
#     proxy_send_timeout 30s;
#     proxy_read_timeout 30s;
#
#     # Don't log every metrics request (too noisy)
#     access_log off;
# }

# =============================================================================
# HTTP-LEVEL CONFIGURATION (Applied Globally)
# =============================================================================
# These settings are automatically active when this file is included

# NOTE: Buffer sizes and timeouts are set per-location above
# The following would apply globally if uncommented (NOT RECOMMENDED):
#
# Global buffer tuning for load testing (ONLY if needed):
# client_body_buffer_size 256k;
# client_header_buffer_size 2k;
# large_client_header_buffers 4 64k;
#
# Global timeout tuning (ONLY if needed):
# client_body_timeout 120s;
# client_header_timeout 120s;
# send_timeout 120s;

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================
#
# 1. SETUP:
#    - Replace YOUR_LOAD_TEST_SECRET_KEY with actual secret (line 30)
#    - Add your CI/CD server IPs to geo block (lines 48-51)
#    - Copy desired location blocks to default.conf server block
#
# 2. ACTIVATE LOAD TESTING:
#    - Include X-Load-Test-Key header in all load test requests
#    - Run tests from whitelisted IP addresses only
#    - Use /api/loadtest/* endpoints instead of /api/* for relaxed limits
#
# 3. EXAMPLE CURL REQUEST:
#    curl -H "X-Load-Test-Key: YOUR_SECRET" \
#         http://localhost/api/loadtest/schedule/list
#
# 4. EXAMPLE K6 LOAD TEST:
#    import http from 'k6/http';
#    export default function() {
#      const params = {
#        headers: { 'X-Load-Test-Key': 'YOUR_SECRET' }
#      };
#      http.get('http://localhost/api/loadtest/persons', params);
#    }
#
# 5. MONITORING:
#    - Check nginx status: curl http://localhost/nginx_status
#    - View load test logs: tail -f /var/log/nginx/loadtest.log
#    - Monitor metrics: curl http://localhost/api/loadtest/metrics
#
# 6. SECURITY CHECKLIST:
#    ✓ Secret key is NOT default value
#    ✓ IP whitelist includes ONLY trusted networks
#    ✓ Load test endpoints are NOT exposed to public internet
#    ✓ Firewall rules prevent external access to load test routes
#    ✓ Load test key is stored in environment variables, not code
#
# =============================================================================
