# =============================================================================
# Upstream Definitions - Load Balancing Configuration
# =============================================================================
# Define upstream server groups for load balancing and high availability.
# Each upstream can have multiple servers with health checks.
# =============================================================================

# -----------------------------------------------------------------------------
# Backend API Servers (FastAPI)
# -----------------------------------------------------------------------------
# Load balancing strategy: least_conn (sends to server with fewest connections)
# Add more backend servers for horizontal scaling
upstream backend_servers {
    # Load balancing method - use least connections for API workloads
    least_conn;

    # Primary backend server
    server backend:8000 weight=5 max_fails=3 fail_timeout=30s;

    # Add additional backend servers for scaling:
    # server backend-2:8000 weight=5 max_fails=3 fail_timeout=30s;
    # server backend-3:8000 weight=5 max_fails=3 fail_timeout=30s;

    # Keep connections alive to upstream servers
    keepalive 32;
    keepalive_requests 1000;
    keepalive_timeout 60s;
}

# -----------------------------------------------------------------------------
# Frontend Servers (Next.js)
# -----------------------------------------------------------------------------
# Load balancing strategy: round_robin (default) for frontend servers
upstream frontend_servers {
    # Primary frontend server
    server frontend:3000 weight=5 max_fails=3 fail_timeout=30s;

    # Add additional frontend servers for scaling:
    # server frontend-2:3000 weight=5 max_fails=3 fail_timeout=30s;
    # server frontend-3:3000 weight=5 max_fails=3 fail_timeout=30s;

    # Keep connections alive
    keepalive 16;
    keepalive_requests 500;
    keepalive_timeout 60s;
}

# -----------------------------------------------------------------------------
# WebSocket Upstream (for real-time features)
# -----------------------------------------------------------------------------
# Separate upstream for WebSocket connections with IP hash for sticky sessions
upstream websocket_servers {
    # Use IP hash for sticky sessions (WebSocket requires persistence)
    ip_hash;

    # Backend WebSocket endpoint
    server backend:8000 max_fails=3 fail_timeout=30s;

    # Add additional WebSocket servers:
    # server backend-2:8000 max_fails=3 fail_timeout=30s;

    # Longer keepalive for WebSocket connections
    keepalive 64;
    keepalive_timeout 120s;
}
