# Pull Request Review Workflow
# Automated PR validation and quality checks
# Runs on all pull requests to ensure quality standards

name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # PR Size Check - Warn on large PRs
  pr-size-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        id: pr-size
        run: |
          # Get changed files and lines
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          DELETED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')
          TOTAL_CHANGES=$((ADDED_LINES + DELETED_LINES))

          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "additions=$ADDED_LINES" >> $GITHUB_OUTPUT
          echo "deletions=$DELETED_LINES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

          echo "## PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed:** $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines Added:** $ADDED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines Deleted:** $DELETED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Changes:** $TOTAL_CHANGES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine size category
          if [ $TOTAL_CHANGES -lt 100 ]; then
            echo "size=xs" >> $GITHUB_OUTPUT
            echo "**Size:** üü¢ XS (< 100 lines)" >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_CHANGES -lt 300 ]; then
            echo "size=small" >> $GITHUB_OUTPUT
            echo "**Size:** üü¢ Small (100-300 lines)" >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_CHANGES -lt 500 ]; then
            echo "size=medium" >> $GITHUB_OUTPUT
            echo "**Size:** üü° Medium (300-500 lines)" >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_CHANGES -lt 1000 ]; then
            echo "size=large" >> $GITHUB_OUTPUT
            echo "**Size:** üü† Large (500-1000 lines)" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Consider breaking this PR into smaller chunks for easier review" >> $GITHUB_STEP_SUMMARY
          else
            echo "size=xl" >> $GITHUB_OUTPUT
            echo "**Size:** üî¥ XL (> 1000 lines)" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **This PR is very large!** Please consider breaking it into smaller, focused PRs" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on large PR
        if: steps.pr-size.outputs.size == 'xl' || steps.pr-size.outputs.size == 'large'
        uses: actions/github-script@v7
        with:
          script: |
            const size = '${{ steps.pr-size.outputs.size }}';
            const files = '${{ steps.pr-size.outputs.files }}';
            const total = '${{ steps.pr-size.outputs.total }}';

            const emoji = size === 'xl' ? 'üî¥' : 'üü†';
            const message = `${emoji} **Large PR Detected**\n\n` +
              `This PR modifies **${files} files** with **${total} total changes**.\n\n` +
              `**Recommendations:**\n` +
              `- Consider breaking this into smaller, focused PRs\n` +
              `- Smaller PRs are easier to review and less likely to introduce bugs\n` +
              `- Aim for < 500 lines of changes per PR when possible\n\n` +
              `If this PR cannot be split, please add a detailed description explaining the scope.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Commit Message Validation
  commit-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          echo "## Commit Message Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          git fetch origin ${{ github.base_ref }}
          COMMITS=$(git log --pretty=format:"%H %s" origin/${{ github.base_ref }}..HEAD)

          INVALID=0
          while IFS= read -r commit; do
            HASH=$(echo "$commit" | cut -d' ' -f1)
            MSG=$(echo "$commit" | cut -d' ' -f2-)

            # Check for conventional commit format (optional)
            # Acceptable prefixes: feat, fix, docs, style, refactor, test, chore, perf, ci, build
            if echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?:|^Merge|^[A-Z]"; then
              echo "- ‚úÖ \`${HASH:0:7}\`: $MSG" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ö†Ô∏è \`${HASH:0:7}\`: $MSG (Consider using conventional commits)" >> $GITHUB_STEP_SUMMARY
              INVALID=$((INVALID + 1))
            fi
          done <<< "$COMMITS"

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $INVALID -gt 0 ]; then
            echo "**Note:** $INVALID commit(s) don't follow conventional commit format" >> $GITHUB_STEP_SUMMARY
            echo "Consider using: feat:, fix:, docs:, refactor:, test:, chore:, etc." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All commits follow good practices!" >> $GITHUB_STEP_SUMMARY
          fi

  # PR Description Check
  pr-description-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            let summary = '## PR Description Check\n\n';
            let hasIssues = false;

            // Check if description is empty or too short
            if (body.length < 50) {
              summary += '‚ùå **Missing or insufficient PR description**\n\n';
              summary += 'Please add a detailed description that includes:\n';
              summary += '- What changes were made\n';
              summary += '- Why these changes were necessary\n';
              summary += '- How to test the changes\n';
              summary += '- Any related issues or tickets\n';
              hasIssues = true;
            } else {
              summary += '‚úÖ PR has a description\n\n';
            }

            // Check for specific sections
            const hasTestPlan = body.toLowerCase().includes('test') || body.toLowerCase().includes('testing');
            const hasSummary = body.toLowerCase().includes('summary') || body.toLowerCase().includes('what') || body.toLowerCase().includes('changes');

            summary += '**Checklist:**\n';
            summary += hasTestPlan ? '- ‚úÖ Test plan mentioned\n' : '- ‚ö†Ô∏è No test plan mentioned\n';
            summary += hasSummary ? '- ‚úÖ Change summary provided\n' : '- ‚ö†Ô∏è No clear summary of changes\n';

            core.summary.addRaw(summary).write();

            // Comment if description is missing
            if (hasIssues) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'üëã **Missing PR Description**\n\n' +
                  'Please add a description to help reviewers understand:\n' +
                  '- What changes were made and why\n' +
                  '- How to test the changes\n' +
                  '- Any related issues or breaking changes\n\n' +
                  'A good description helps speed up the review process!'
              });
            }

  # Changed Files Analysis
  changed-files-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze changed files
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "## Changed Files Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count changes by type
          PY_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.py$" | wc -l || echo 0)
          TS_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(ts|tsx)$" | wc -l || echo 0)
          TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "test_.*\.py$|\.test\.(ts|tsx)$|\.spec\.(ts|tsx)$" | wc -l || echo 0)
          CONFIG_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(yml|yaml|json|toml|ini|env)$" | wc -l || echo 0)
          DOC_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(md|rst|txt)$" | wc -l || echo 0)

          echo "### File Types Changed" >> $GITHUB_STEP_SUMMARY
          echo "- **Python:** $PY_FILES files" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript/TSX:** $TS_FILES files" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests:** $TEST_FILES files" >> $GITHUB_STEP_SUMMARY
          echo "- **Config:** $CONFIG_FILES files" >> $GITHUB_STEP_SUMMARY
          echo "- **Docs:** $DOC_FILES files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if tests were added with code changes
          if [ $PY_FILES -gt 0 ] || [ $TS_FILES -gt 0 ]; then
            if [ $TEST_FILES -eq 0 ]; then
              echo "‚ö†Ô∏è **Code changed but no test files modified**" >> $GITHUB_STEP_SUMMARY
              echo "Consider adding tests for your changes" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ Tests included with code changes" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # List all changed files
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### All Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Breaking Changes Detection
  breaking-changes-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for potential breaking changes
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "## Breaking Changes Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for database migrations
          MIGRATIONS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "alembic/versions/.*\.py$" | wc -l || echo 0)

          # Check for API schema changes
          SCHEMA_CHANGES=$(git diff origin/${{ github.base_ref }}...HEAD -- "backend/app/schemas/*.py" "backend/app/api/routes/*.py" | grep -E "^[\+\-]" | wc -l || echo 0)

          # Check for model changes
          MODEL_CHANGES=$(git diff origin/${{ github.base_ref }}...HEAD -- "backend/app/models/*.py" | grep -E "^[\+\-]" | wc -l || echo 0)

          # Check for environment variable changes
          ENV_CHANGES=$(git diff origin/${{ github.base_ref }}...HEAD -- ".env.example" "docker-compose.yml" | grep -E "^[\+\-]" | wc -l || echo 0)

          BREAKING=false

          if [ $MIGRATIONS -gt 0 ]; then
            echo "‚ö†Ô∏è **Database migrations detected** ($MIGRATIONS)" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure migrations are backward compatible" >> $GITHUB_STEP_SUMMARY
            echo "- Document migration process in PR description" >> $GITHUB_STEP_SUMMARY
            BREAKING=true
          fi

          if [ $SCHEMA_CHANGES -gt 50 ]; then
            echo "‚ö†Ô∏è **Significant API schema changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "- Review for breaking API changes" >> $GITHUB_STEP_SUMMARY
            echo "- Update API documentation" >> $GITHUB_STEP_SUMMARY
            BREAKING=true
          fi

          if [ $MODEL_CHANGES -gt 50 ]; then
            echo "‚ö†Ô∏è **Significant model changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure database compatibility" >> $GITHUB_STEP_SUMMARY
            BREAKING=true
          fi

          if [ $ENV_CHANGES -gt 0 ]; then
            echo "‚ö†Ô∏è **Environment configuration changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "- Update deployment documentation" >> $GITHUB_STEP_SUMMARY
            echo "- Notify DevOps team" >> $GITHUB_STEP_SUMMARY
            BREAKING=true
          fi

          if [ "$BREAKING" = false ]; then
            echo "‚úÖ No obvious breaking changes detected" >> $GITHUB_STEP_SUMMARY
          fi

  # Security Checks
  security-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Security pattern check
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "## Security Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for potential secrets in diff
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(password|secret|api_key|token|private_key)\s*=\s*['\"][^'\"]+['\"]"; then
            echo "‚ö†Ô∏è **Potential hardcoded secrets detected**" >> $GITHUB_STEP_SUMMARY
            echo "Review the changes carefully and ensure no secrets are committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No obvious hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for authentication changes
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "auth|security|permission"; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Authentication/Security files changed**" >> $GITHUB_STEP_SUMMARY
            echo "Extra careful review required for security-sensitive changes" >> $GITHUB_STEP_SUMMARY
          fi

  # Performance Impact Check
  performance-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for performance-sensitive changes
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "## Performance Impact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for database query changes
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "session\.query|select\(|\.filter\(|\.join\("; then
            echo "‚ö†Ô∏è **Database query changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "- Review for N+1 query problems" >> $GITHUB_STEP_SUMMARY
            echo "- Consider adding database indexes if needed" >> $GITHUB_STEP_SUMMARY
            echo "- Test with production-like data volumes" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for large data structure changes
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "for.*in.*for.*in|\.map\(.*\.map\("; then
            echo "‚ö†Ô∏è **Nested loops detected in changes**" >> $GITHUB_STEP_SUMMARY
            echo "Review for O(n¬≤) complexity issues" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for synchronous operations in async code
          if git diff origin/${{ github.base_ref }}...HEAD -- "backend/**/*.py" | grep -E "requests\.get|requests\.post" | grep -v "httpx"; then
            echo "‚ö†Ô∏è **Synchronous HTTP requests in async codebase**" >> $GITHUB_STEP_SUMMARY
            echo "Consider using async httpx instead of sync requests" >> $GITHUB_STEP_SUMMARY
          fi

  # Test Coverage Check
  test-coverage-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check test coverage
        run: |
          git fetch origin ${{ github.base_ref }}

          echo "## Test Coverage Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count new functions/methods added
          NEW_FUNCTIONS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+\s*(def |async def |function |const.*=.*\()" | wc -l || echo 0)

          # Count new test functions
          NEW_TESTS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+\s*(def test_|it\(|test\()" | wc -l || echo 0)

          echo "- **New functions/methods:** $NEW_FUNCTIONS" >> $GITHUB_STEP_SUMMARY
          echo "- **New tests:** $NEW_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $NEW_FUNCTIONS -gt 0 ]; then
            RATIO=$(awk "BEGIN {printf \"%.2f\", $NEW_TESTS / $NEW_FUNCTIONS}")
            echo "- **Test ratio:** $RATIO tests per function" >> $GITHUB_STEP_SUMMARY

            if (( $(echo "$RATIO < 0.5" | bc -l) )); then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è **Low test coverage ratio**" >> $GITHUB_STEP_SUMMARY
              echo "Consider adding more tests for new functionality" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ Good test coverage ratio" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # Final PR Review Summary
  pr-review-summary:
    runs-on: ubuntu-latest
    needs:
      - pr-size-check
      - commit-validation
      - pr-description-check
      - changed-files-analysis
      - breaking-changes-check
      - security-review
      - performance-check
      - test-coverage-check
    if: always()

    steps:
      - name: Generate review summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'PR Size': '${{ needs.pr-size-check.result }}',
              'Commit Validation': '${{ needs.commit-validation.result }}',
              'PR Description': '${{ needs.pr-description-check.result }}',
              'Changed Files': '${{ needs.changed-files-analysis.result }}',
              'Breaking Changes': '${{ needs.breaking-changes-check.result }}',
              'Security Review': '${{ needs.security-review.result }}',
              'Performance Check': '${{ needs.performance-check.result }}',
              'Test Coverage': '${{ needs.test-coverage-check.result }}'
            };

            let summary = '## üìã PR Review Summary\n\n';
            let allPassed = true;

            for (const [check, result] of Object.entries(results)) {
              const emoji = result === 'success' ? '‚úÖ' : '‚ùå';
              summary += `${emoji} **${check}**: ${result}\n`;
              if (result !== 'success') allPassed = false;
            }

            summary += '\n';

            if (allPassed) {
              summary += 'üéâ All automated PR checks passed!\n\n';
              summary += 'The PR is ready for human review.';
            } else {
              summary += '‚ö†Ô∏è Some automated checks failed or need attention.\n\n';
              summary += 'Please review the individual check results above.';
            }

            core.summary.addRaw(summary).write();
