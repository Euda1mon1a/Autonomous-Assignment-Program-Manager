# Continuous Deployment Workflow
# Deploys to staging on pushes to main, production on releases
# Uses Docker images pushed to GitHub Container Registry (GHCR)

name: CD - Deploy

on:
  push:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test verification'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend

jobs:
  # Build and push Docker images
  build-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=sha-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL || 'http://localhost:8000' }}

  # Deploy to staging environment via Render
  # Render uses deploy hooks - simple POST requests that trigger service rebuilds
  # Deploy hooks are configured in Render dashboard > Service > Settings > Deploy Hook
  # Store the hook URL in GitHub Secrets as RENDER_DEPLOY_HOOK_URL
  deploy-staging:
    needs: build-images
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Trigger Render Deploy (Staging)
        run: |
          echo "Deploying to Render staging environment..."
          echo "Version: ${{ needs.build-images.outputs.version }}"

          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "::warning::RENDER_DEPLOY_HOOK_URL not set, skipping deploy"
            echo "To configure: Render Dashboard > Service > Settings > Deploy Hook"
            exit 0
          fi

          # Trigger Render deploy hook
          # Render will pull latest code and rebuild the service
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Accept: application/json" \
            --fail --silent --show-error

          echo "Deploy hook triggered successfully"

      - name: Wait for Render deployment
        run: |
          # Give Render time to start the deployment
          # Note: For more robust checks, use Render API to poll deployment status
          echo "Waiting for Render to process deployment..."
          sleep 30

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against staging..."
          if [ -n "${{ vars.STAGING_URL }}" ]; then
            # Retry health check up to 5 times with 10s delay
            for i in {1..5}; do
              if curl --fail --silent "${{ vars.STAGING_URL }}/api/health"; then
                echo "Health check passed"
                exit 0
              fi
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            done
            echo "::warning::Health check failed after 5 attempts"
          else
            echo "::warning::STAGING_URL not set, skipping smoke tests"
          fi

      - name: Notify deployment
        if: always()
        run: |
          echo "Staging deployment completed with status: ${{ job.status }}"
          # Optional: Notify via Slack, Discord, etc.
          # if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          #   curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
          #     -H "Content-Type: application/json" \
          #     -d '{"text":"Staging deployment: ${{ job.status }} (version: ${{ needs.build-images.outputs.version }})"}'
          # fi

  # Deploy to production environment via Render (only on releases)
  # Production uses a separate deploy hook for isolation
  # Store in GitHub Secrets as RENDER_PROD_DEPLOY_HOOK_URL
  # Render supports manual approval via GitHub Environments
  deploy-production:
    needs: [build-images, deploy-staging]
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Trigger Render Deploy (Production)
        run: |
          echo "Deploying to Render production environment..."
          echo "Version: ${{ needs.build-images.outputs.version }}"

          if [ -z "${{ secrets.RENDER_PROD_DEPLOY_HOOK_URL }}" ]; then
            echo "::warning::RENDER_PROD_DEPLOY_HOOK_URL not set, skipping deploy"
            echo "To configure: Render Dashboard > Service > Settings > Deploy Hook"
            exit 0
          fi

          # Trigger Render production deploy hook
          curl -X POST "${{ secrets.RENDER_PROD_DEPLOY_HOOK_URL }}" \
            -H "Accept: application/json" \
            --fail --silent --show-error

          echo "Production deploy hook triggered successfully"

      - name: Wait for Render deployment
        run: |
          # Give Render time to process the deployment
          echo "Waiting for Render to process production deployment..."
          sleep 45

      - name: Run production smoke tests
        run: |
          echo "Running production smoke tests..."
          if [ -n "${{ vars.PRODUCTION_URL }}" ]; then
            # More retries for production (services may take longer)
            for i in {1..8}; do
              if curl --fail --silent "${{ vars.PRODUCTION_URL }}/api/health"; then
                echo "Production health check passed"
                exit 0
              fi
              echo "Attempt $i failed, retrying in 15s..."
              sleep 15
            done
            echo "::error::Production health check failed after 8 attempts"
            exit 1
          else
            echo "::warning::PRODUCTION_URL not set, skipping smoke tests"
          fi

      - name: Create deployment record
        run: |
          echo "Recording deployment: ${{ needs.build-images.outputs.version }}"
          echo "Deployed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          # Optional: Log to external tracking system

      - name: Notify production deployment
        if: always()
        run: |
          echo "Production deployment completed with status: ${{ job.status }}"
          # Optional: Notify stakeholders via Slack, PagerDuty, etc.
          # if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          #   curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
          #     -H "Content-Type: application/json" \
          #     -d '{"text":"PRODUCTION deployment: ${{ job.status }} (version: ${{ needs.build-images.outputs.version }})"}'
          # fi

  # Run database migrations (separate job for safety)
  # Note: For Render, migrations typically run as part of the build command
  # in render.yaml. This job is for manual migration runs or pre-deploy checks.
  # Render's DATABASE_URL is injected automatically into services.
  run-migrations:
    needs: [build-images]
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event_name == 'release' && 'production' || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running database migrations..."
          if [ -z "$DATABASE_URL" ]; then
            echo "::warning::DATABASE_URL not set - migrations run via Render build command"
            echo "See render.yaml buildCommand for automatic migration execution"
            exit 0
          fi
          # For manual migration runs when DATABASE_URL is configured
          # alembic upgrade head
          echo "Migrations completed (dry-run in CI)"

  # Rollback job (manual trigger only)
  # Render supports rollback via:
  # 1. Dashboard: Service > Deploys > select previous deploy > "Rollback"
  # 2. API: Use Render API to trigger rollback (requires API key)
  # This job provides a workflow-based rollback option
  rollback:
    if: github.event_name == 'workflow_dispatch' && failure()
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    needs: [deploy-staging, deploy-production]

    steps:
      - name: Rollback deployment
        run: |
          echo "Rolling back deployment..."
          echo "Environment: ${{ github.event.inputs.environment }}"

          # Render rollback options:
          # Option 1: Use Render Dashboard (recommended for quick rollbacks)
          #   - Go to Render Dashboard > Service > Deploys
          #   - Click on previous successful deploy
          #   - Click "Rollback to this deploy"

          # Option 2: Re-deploy previous Git commit
          #   - Push a revert commit: git revert HEAD && git push

          # Option 3: Use Render API (if RENDER_API_KEY is configured)
          # if [ -n "${{ secrets.RENDER_API_KEY }}" ]; then
          #   curl -X POST "https://api.render.com/v1/services/$SERVICE_ID/rollback" \
          #     -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          #     -H "Content-Type: application/json"
          # fi

          echo "::warning::Manual rollback required - see Render Dashboard"
          echo "Dashboard: https://dashboard.render.com"
