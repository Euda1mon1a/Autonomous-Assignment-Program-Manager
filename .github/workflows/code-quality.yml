# Code Quality Workflow
# Runs linting, type checking, and code formatting verification
# on pull requests and pushes
#
# DISABLED 2026-01-10: Redundant with ci.yml. See docs/CI_STREAMLINING_GUIDE.md
# To re-enable: Remove `if: false` from jobs below

name: Code Quality (DISABLED)

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches:
      - main
      - master
      - 'claude/**'  # Claude Code AI-created branches

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # Detect which parts of the codebase changed
  changes:
    if: false  # DISABLED - redundant with ci.yml
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # Backend code quality checks
  backend-quality:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements*.txt'

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Lint Python code with Ruff for style and potential issues
      # Output formatted for GitHub annotations in PR
      - name: Run Ruff linter
        working-directory: backend
        run: |
          ruff check . --output-format=github

      # Verify Ruff code formatting compliance
      # Ensures consistent code style across the codebase
      - name: Run Ruff formatter check
        working-directory: backend
        run: |
          ruff format --check .

      # Verify Black code formatting compliance
      # Shows diff of formatting issues for easy review
      - name: Run Black formatter check
        working-directory: backend
        run: |
          black --check --diff .

      # Run MyPy static type checking
      # Currently non-blocking to allow gradual type adoption
      # TODO: Remove || true once codebase is fully typed
      - name: Run MyPy type checker
        working-directory: backend
        run: |
          mypy app --ignore-missing-imports --no-error-summary || true

      # Verify import statement ordering with Ruff
      # Ensures consistent import organization
      - name: Check import sorting
        working-directory: backend
        run: |
          ruff check --select I .

  # Frontend code quality checks
  frontend-quality:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      # Lint TypeScript/JavaScript code with ESLint
      # Enforces code quality and catches potential bugs
      - name: Run ESLint
        working-directory: frontend
        run: npm run lint

      # Verify TypeScript type correctness without emitting files
      # Catches type errors early in development cycle
      - name: Run TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit

      # Check Prettier code formatting compliance
      # Currently non-blocking while Prettier config is finalized
      # TODO: Remove || true once Prettier is fully configured
      - name: Check Prettier formatting
        working-directory: frontend
        run: |
          npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}" || true

  # Check for common issues across the codebase
  common-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Prevent accidental commits of merge conflict markers
      # Scans all code files for Git conflict syntax
      - name: Check for merge conflicts markers
        run: |
          if grep -rn "<<<<<<< HEAD" --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" .; then
            echo "Error: Found merge conflict markers in codebase"
            exit 1
          fi
          echo "No merge conflict markers found"

      # Detect debug statements that should not be committed
      # Checks for pdb, breakpoint(), and debugger statements
      - name: Check for debug statements
        run: |
          echo "Checking for debug statements..."
          # Python debug statements
          if grep -rn "import pdb" --include="*.py" backend/app/; then
            echo "Warning: Found pdb imports in production code"
          fi
          if grep -rn "breakpoint()" --include="*.py" backend/app/; then
            echo "Warning: Found breakpoint() calls in production code"
          fi
          # JavaScript/TypeScript debug statements
          if grep -rn "debugger" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" frontend/src/; then
            echo "Warning: Found debugger statements in frontend code"
          fi
          echo "Debug statement check completed"

      - name: Check for TODO/FIXME comments
        run: |
          echo "Listing TODO/FIXME comments (informational)..."
          grep -rn "TODO\|FIXME" --include="*.py" --include="*.ts" --include="*.tsx" backend/app/ frontend/src/ || echo "No TODO/FIXME comments found"

      - name: Check for hardcoded secrets patterns
        run: |
          echo "Checking for potential hardcoded secrets..."
          # Check for common secret patterns (this is a basic check, use dedicated tools for thorough scanning)
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
          )
          for pattern in "${PATTERNS[@]}"; do
            if grep -rniE "$pattern" --include="*.py" --include="*.ts" --include="*.tsx" backend/app/ frontend/src/ 2>/dev/null; then
              echo "Warning: Found potential hardcoded secret pattern: $pattern"
            fi
          done
          echo "Secret pattern check completed"

      # Validate YAML syntax in workflow and config files
      # Prevents syntax errors from breaking CI/CD pipelines
      # Checks first 20 YAML files to avoid timeout
      - name: Validate YAML files
        run: |
          echo "Validating YAML files..."
          find . -name "*.yml" -o -name "*.yaml" | head -20 | while read file; do
            if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "Valid: $file"
            else
              echo "Invalid YAML: $file"
              exit 1
            fi
          done

      # Validate JSON syntax in config files
      # Skips .vscode and .zed which use JSONC (JSON with comments)
      - name: Check JSON files
        run: |
          echo "Validating JSON files..."
          # Skip .vscode and .zed directories - they use JSONC (JSON with comments)
          find . -name "*.json" \
            -not -path "*/node_modules/*" \
            -not -path "*/.git/*" \
            -not -path "*/.vscode/*" \
            -not -path "*/.zed/*" | while read file; do
            if python3 -c "import json; json.load(open('$file'))" 2>/dev/null; then
              echo "Valid: $file"
            else
              echo "Invalid JSON: $file"
              exit 1
            fi
          done

  # Code complexity analysis
  complexity-analysis:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || github.event_name == 'push' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install analysis tools
        run: |
          pip install radon xenon

      - name: Python cyclomatic complexity
        if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'push' }}
        working-directory: backend
        run: |
          echo "Cyclomatic Complexity Analysis (A=low, F=high):"
          radon cc app -a -s || true

      - name: Python maintainability index
        if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'push' }}
        working-directory: backend
        run: |
          echo "Maintainability Index (100=best, 0=worst):"
          radon mi app -s || true

      - name: Check complexity thresholds
        if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'push' }}
        working-directory: backend
        run: |
          # Fail if any function has complexity > 20 (configurable)
          xenon --max-absolute C --max-modules B --max-average A app || echo "High complexity detected - review recommended"

  # Summary job
  quality-summary:
    runs-on: ubuntu-latest
    needs: [changes, backend-quality, frontend-quality, common-checks, complexity-analysis]
    if: always()

    steps:
      - name: Check quality status
        run: |
          echo "Backend quality: ${{ needs.backend-quality.result }}"
          echo "Frontend quality: ${{ needs.frontend-quality.result }}"
          echo "Common checks: ${{ needs.common-checks.result }}"
          echo "Complexity analysis: ${{ needs.complexity-analysis.result }}"

          if [[ "${{ needs.backend-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.common-checks.result }}" == "failure" ]]; then
            echo "Code quality checks failed"
            exit 1
          fi

          echo "All code quality checks passed!"
