# Enhanced CI Workflow with Matrix Testing
# This is an alternative to ci.yml with matrix builds for multiple Python/Node versions
# Runs tests, type checking, and linting in parallel for fast feedback

name: CI - Enhanced

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  POETRY_VERSION: "1.7.1"
  MIN_COVERAGE: 75

jobs:
  # Detect which parts of the codebase changed
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'requirements*.txt'
              - 'pyproject.toml'
            frontend:
              - 'frontend/**'
              - 'package*.json'
            workflows:
              - '.github/workflows/**'

  # Fast quality checks - fail fast on obvious issues
  quick-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for merge conflicts
        run: |
          if grep -r "<<<<<<< HEAD\|=======\|>>>>>>>" --include="*.py" --include="*.ts" --include="*.tsx" .; then
            echo "❌ Merge conflict markers found"
            exit 1
          fi

      - name: Check for debug statements
        run: |
          # Python
          if grep -r "import pdb\|breakpoint()" --include="*.py" backend/app/; then
            echo "⚠️ Debug statements found in backend"
          fi
          # JavaScript/TypeScript
          if grep -r "debugger;" --include="*.ts" --include="*.tsx" frontend/src/; then
            echo "⚠️ Debug statements found in frontend"
          fi

      - name: Validate YAML syntax
        run: |
          python3 -c "
          import yaml
          import sys
          from pathlib import Path

          failed = []
          for file in Path('.github/workflows').glob('*.yml'):
              try:
                  yaml.safe_load(file.read_text())
                  print(f'✓ {file}')
              except Exception as e:
                  print(f'✗ {file}: {e}')
                  failed.append(file)

          if failed:
              sys.exit(1)
          "

      - name: Check for large files
        run: |
          # Find files larger than 1MB (excluding node_modules, venv, etc.)
          find . -type f -size +1M \
            -not -path "*/node_modules/*" \
            -not -path "*/.git/*" \
            -not -path "*/venv/*" \
            -not -path "*/__pycache__/*" \
            -not -path "*/htmlcov/*" \
            -not -path "*/.pytest_cache/*" \
            -exec ls -lh {} \; | awk '{print $9, $5}' || echo "No large files found"

  # Backend Matrix Testing - Test multiple Python versions
  backend-matrix:
    needs: [changes, quick-checks]
    if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'push' }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11', '3.12']
        include:
          # Also test on macOS for Python 3.11
          - os: macos-latest
            python-version: '3.11'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements*.txt'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('backend/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Run type checking (MyPy)
        if: matrix.python-version == '3.11'  # Only run once
        working-directory: backend
        run: |
          mypy app --ignore-missing-imports --check-untyped-defs || echo "Type checking completed with warnings"

      - name: Run linting (Ruff)
        if: matrix.python-version == '3.11'  # Only run once
        working-directory: backend
        run: |
          ruff check . --output-format=github

      - name: Check code formatting (Black)
        if: matrix.python-version == '3.11'  # Only run once
        working-directory: backend
        run: |
          black --check --diff .

      - name: Run database migrations
        working-directory: backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          SECRET_KEY: test-secret-key-minimum-32-chars-long-for-ci-testing
          WEBHOOK_SECRET: test-webhook-secret-minimum-32-chars-long
        run: |
          alembic upgrade head

      - name: Run tests with coverage
        working-directory: backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-minimum-32-chars-long-for-ci-testing
          WEBHOOK_SECRET: test-webhook-secret-minimum-32-chars-long
          DEBUG: "true"
          TESTING: "true"
        run: |
          pytest \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.MIN_COVERAGE }} \
            -v \
            --maxfail=5 \
            --tb=short \
            -m "not slow and not e2e"

      - name: Run integration tests
        working-directory: backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-minimum-32-chars-long-for-ci-testing
          WEBHOOK_SECRET: test-webhook-secret-minimum-32-chars-long
          DEBUG: "true"
          TESTING: "true"
        run: |
          pytest \
            -v \
            -m "integration" \
            --tb=short

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: backend/coverage.xml
          flags: backend
          name: backend-py${{ matrix.python-version }}
          fail_ci_if_error: false

      - name: Upload coverage HTML report
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-py${{ matrix.python-version }}
          path: backend/htmlcov/
          retention-days: 7

  # Frontend Matrix Testing - Test multiple Node versions
  frontend-matrix:
    needs: [changes, quick-checks]
    if: ${{ needs.changes.outputs.frontend == 'true' || github.event_name == 'push' }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node-version: ['18.x', '20.x']
        include:
          # Also test on Windows for Node 20
          - os: windows-latest
            node-version: '20.x'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            frontend/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run type checking
        if: matrix.node-version == '20.x' && matrix.os == 'ubuntu-latest'
        working-directory: frontend
        run: npm run type-check

      - name: Run linting
        if: matrix.node-version == '20.x' && matrix.os == 'ubuntu-latest'
        working-directory: frontend
        run: npm run lint

      - name: Run unit tests
        working-directory: frontend
        run: npm run test:ci

      - name: Build application
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
          NODE_ENV: production
        run: npm run build

      - name: Upload coverage to Codecov
        if: matrix.node-version == '20.x' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: frontend/coverage/lcov.info
          flags: frontend
          name: frontend-node${{ matrix.node-version }}
          fail_ci_if_error: false

      - name: Upload coverage HTML report
        if: matrix.node-version == '20.x' && matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-node${{ matrix.node-version }}
          path: frontend/coverage/
          retention-days: 7

  # E2E Tests - Only run on primary versions
  e2e-tests:
    needs: [changes, quick-checks]
    if: ${{ needs.changes.outputs.frontend == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000

      - name: Run E2E tests
        working-directory: frontend
        run: npm run test:e2e -- --project=chromium
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: frontend/test-results/
          retention-days: 7

  # Security scanning
  security-scan:
    runs-on: ubuntu-latest
    needs: quick-checks
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities, just report

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Dependency audit
  dependency-audit:
    runs-on: ubuntu-latest
    needs: changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Python dependency audit
        if: needs.changes.outputs.backend == 'true'
        run: |
          pip install pip-audit
          cd backend
          pip-audit -r requirements.txt --desc || echo "⚠️ Vulnerabilities found in Python dependencies"

      - name: NPM audit
        if: needs.changes.outputs.frontend == 'true'
        working-directory: frontend
        run: |
          npm audit --audit-level=moderate || echo "⚠️ Vulnerabilities found in NPM dependencies"

  # Final status check
  ci-status:
    runs-on: ubuntu-latest
    needs:
      - quick-checks
      - backend-matrix
      - frontend-matrix
      - e2e-tests
      - security-scan
      - dependency-audit
    if: always()

    steps:
      - name: Check all job statuses
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quick Checks | ${{ needs.quick-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Matrix | ${{ needs.backend-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Matrix | ${{ needs.frontend-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any required jobs failed
          if [[ "${{ needs.quick-checks.result }}" == "failure" ]] || \
             [[ "${{ needs.backend-matrix.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-matrix.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
            echo "❌ CI failed - one or more required jobs failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Warn on security/dependency issues but don't fail
          if [[ "${{ needs.security-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.dependency-audit.result }}" == "failure" ]]; then
            echo "⚠️ Security or dependency issues detected - review recommended" >> $GITHUB_STEP_SUMMARY
          fi

          echo "✅ All required CI checks passed!" >> $GITHUB_STEP_SUMMARY
