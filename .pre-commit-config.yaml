repos:
  # ============================================================================
  # PHASE 1: Security Scanning (First Line of Defense)
  # ============================================================================

  # PII/OPSEC/PERSEC scanning (medical residency context)
  - repo: local
    hooks:
      - id: pii-scan
        name: PII/OPSEC scanner (military medical data)
        entry: scripts/pii-scan.sh
        language: script
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

  # Secret detection - prevent accidentally committing credentials
  # Uses --no-git to scan files only (not git history which has many false positives from docs/tests)
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.2
    hooks:
      - id: gitleaks
        name: Gitleaks - Detect secrets
        entry: gitleaks detect --no-git --verbose --config .gitleaks.toml
        language: golang
        stages: [pre-commit]
        pass_filenames: false

  # ============================================================================
  # PHASE 2: Python Backend Quality (Ruff)
  # ============================================================================

  # Ruff linting - fast, comprehensive Python linter
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.9
    hooks:
      # Linting with fixes applied
      - id: ruff
        name: ruff lint
        args: [--config, backend/pyproject.toml, --fix, --exit-zero]
        files: ^backend/
        stages: [pre-commit]

      # Code formatting
      - id: ruff-format
        name: ruff format
        args: [--config, backend/pyproject.toml]
        files: ^backend/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 3: Python Type Checking (MyPy)
  # ============================================================================

  # Type checking - optional but recommended
  - repo: local
    hooks:
      - id: mypy
        name: mypy (type check)
        entry: bash -c "cd backend && mypy app/ --ignore-missing-imports --no-error-summary"
        language: system
        pass_filenames: false
        files: ^backend/app/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 4: General File Quality
  # ============================================================================

  # Check for merge conflict markers
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Detect merge conflicts
      - id: check-merge-conflict
        name: Check for merge conflicts
        stages: [pre-commit]

      # Ensure files end with newline
      - id: end-of-file-fixer
        name: End of file fixer
        stages: [pre-commit]

      # Detect large files
      - id: check-added-large-files
        name: Check for added large files
        args: ['--maxkb=1000']
        exclude: '^frontend/src/types/api-generated\.ts$'  # Generated types file (source of truth for drift detection)
        stages: [pre-commit]

      # Check YAML syntax
      - id: check-yaml
        name: Check YAML syntax
        args: [--unsafe]
        stages: [pre-commit]

      # Check JSON syntax
      - id: check-json
        name: Check JSON syntax
        stages: [pre-commit]

      # Check for debugger statements in Python
      - id: debug-statements
        name: Check for debugger statements
        stages: [pre-commit]

      # Check for executable scripts
      - id: check-executables-have-shebangs
        name: Check executables have shebangs
        stages: [pre-commit]

      # Trim trailing whitespace
      - id: trailing-whitespace
        name: Trim trailing whitespace
        args: [--markdown-linebreak-ext=md]
        stages: [pre-commit]

  # ============================================================================
  # PHASE 5: Python Security (Bandit)
  # ============================================================================

  # Bandit - Python security linter (uses pyproject.toml config automatically)
  - repo: local
    hooks:
      - id: bandit
        name: bandit (Python security)
        entry: bash -c "cd backend && bandit -r app -ll"
        language: system
        types: [python]
        files: ^backend/app/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 6: Frontend TypeScript/JavaScript Quality
  # ============================================================================

  # Frontend linting via npm scripts
  - repo: local
    hooks:
      - id: eslint
        name: eslint (frontend linting)
        entry: bash -c "cd frontend && npm run lint:fix"
        language: system
        pass_filenames: false
        files: ^frontend/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 7: Frontend Type Checking
  # ============================================================================

  # TypeScript type checking
  - repo: local
    hooks:
      - id: tsc
        name: tsc (TypeScript type check)
        entry: bash -c "cd frontend && npm run type-check"
        language: system
        pass_filenames: false
        files: ^frontend/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 8: Migration Name Validation
  # ============================================================================

  # Alembic migration revision ID length validator
  # Prevents varchar(32) overflow in alembic_version table
  # Reference: Session 054 - alembic_version column length fix
  - repo: local
    hooks:
      - id: migration-names
        name: Migration revision ID length check
        entry: scripts/validate-migration-names.sh --staged
        language: script
        pass_filenames: false
        stages: [pre-commit]
        files: ^backend/alembic/versions/.*\.py$

  # ============================================================================
  # PHASE 8b: Lich's Phylactery (Sacred Timeline)
  # ============================================================================

  # Auto-dump schema.sql when migrations or models change
  # Named after the D&D lich's phylactery - stores the soul for resurrection
  # schema.sql stores the DB's essence so structure can be resurrected
  # Reference: Sacred Timeline preservation for dev environments
  - repo: local
    hooks:
      - id: lichs-phylactery
        name: Lich's Phylactery (schema snapshot)
        entry: scripts/lichs-phylactery.sh
        language: script
        pass_filenames: false
        files: ^backend/(alembic/versions/.*\.py|app/models/.*\.py)$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 9: MCP Configuration Validation
  # ============================================================================

  # MCP config validator - prevent transport/auth configuration drift
  # Reference: .claude/Scratchpad/MCP_TRANSPORT_FIX_20260102.md
  - repo: local
    hooks:
      - id: mcp-config
        name: MCP configuration validator
        entry: scripts/validate-mcp-config.sh
        language: script
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        files: ^(\.mcp\.json|mcp-server/|docker-compose\.yml|\.env\.example)

  # ============================================================================
  # PHASE 10: Commit Message Validation
  # ============================================================================

  # Conventional commits - enforce commit message format
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v3.12.0
    hooks:
      - id: commitizen
        name: Conventional commit format
        entry: cz check
        stages: [commit-msg]
        language: python

  # ============================================================================
  # PHASE 11: YAML Validation
  # ============================================================================

  # YAML linting for GitHub Actions and configs
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        name: YAML lint
        args: ['--config-data', '{extends: relaxed, rules: {line-length: {max: 120}}}']
        files: ^\.github/workflows/.*\.ya?ml$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 12: ACGME Compliance (Session 082 - MEDCOM Domain)
  # ============================================================================

  # ACGME rule validation for scheduling code
  - repo: local
    hooks:
      - id: acgme-validate
        name: ACGME Compliance Check
        entry: scripts/validate-acgme-compliance.sh
        language: script
        pass_filenames: false
        files: ^(backend/app/scheduling/|frontend/src/features/.*schedule)
        stages: [pre-commit]

  # ============================================================================
  # PHASE 13: Resilience N-1/N-2 (Session 082 - RESILIENCE_ENGINEER Domain)
  # ============================================================================

  # Resilience and contingency validation
  - repo: local
    hooks:
      - id: resilience-check
        name: Resilience N-1/N-2 Validation
        entry: scripts/validate-resilience-constraints.sh
        language: script
        pass_filenames: false
        files: ^backend/app/(scheduling|resilience)/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 14: Swap Safety (Session 082 - SWAP_MANAGER Domain)
  # ============================================================================

  # Swap operation safety validation
  - repo: local
    hooks:
      - id: swap-validate
        name: Swap Safety Validation
        entry: scripts/validate-swap-safety.sh
        language: script
        pass_filenames: false
        files: ^backend/app/(api/routes/swap|services/swap|models/swap)
        stages: [pre-commit]

  # ============================================================================
  # PHASE 15: Schedule Integrity (Session 082 - SCHEDULER Domain)
  # ============================================================================

  # Schedule data integrity validation
  - repo: local
    hooks:
      - id: schedule-integrity
        name: Schedule Data Integrity
        entry: scripts/validate-schedule-integrity.sh
        language: script
        pass_filenames: false
        files: ^(backend/app/scheduling/|docs/data/.*schedule)
        stages: [pre-commit]

  # ============================================================================
  # PHASE 16: Documentation Completeness (Session 082 - META_UPDATER Domain)
  # ============================================================================

  # Documentation completeness checks
  - repo: local
    hooks:
      - id: docs-check
        name: Documentation Completeness
        entry: scripts/validate-documentation.sh
        language: script
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

  # ============================================================================
  # PHASE 17: Constraint Registration (Session 083 - SCHEDULER Domain)
  # ============================================================================

  # Constraint registration validation - catches "implemented but not registered" bugs
  - repo: local
    hooks:
      - id: constraint-registration
        name: Constraint Registration Validation
        entry: scripts/validate-constraint-registration.sh
        language: script
        pass_filenames: false
        files: ^backend/app/scheduling/constraints/
        stages: [pre-commit]

  # ============================================================================
  # PHASE 18: MCP Tool Validation (Session 084 - SCHEDULER Domain)
  # ============================================================================

  # MCP tool structure and registration validation
  - repo: local
    hooks:
      - id: mcp-tools-validate
        name: MCP Tool Structure Validation
        entry: scripts/validate-mcp-tools.sh
        language: script
        pass_filenames: false
        files: ^mcp-server/src/scheduler_mcp/(tools|armory)/.*\.py$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 19: Test Coverage Validation (Session 084 - QA Domain)
  # ============================================================================

  # Test file existence and coverage reminder
  - repo: local
    hooks:
      - id: test-coverage
        name: Test Coverage Reminder
        entry: scripts/validate-test-coverage.sh
        language: script
        pass_filenames: false
        files: ^(backend/app/|frontend/src/).*\.(py|ts|tsx)$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 20: Bundle Size Monitoring (Session 084 - FRONTEND Domain)
  # ============================================================================

  # Dependency monitoring and bundle size awareness
  - repo: local
    hooks:
      - id: bundle-size
        name: Bundle Size Monitor
        entry: scripts/validate-bundle-size.sh
        language: script
        pass_filenames: false
        files: ^frontend/package\.json$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 21: API Contract Validation (Session 084 - ARCHITECT Domain)
  # ============================================================================

  # Backend/frontend type sync validation
  - repo: local
    hooks:
      - id: api-contract
        name: API Contract Validation
        entry: scripts/validate-api-contract.sh
        language: script
        pass_filenames: false
        files: ^(backend/app/schemas/|frontend/src/types/).*\.(py|ts)$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 22: Performance Regression (Session 085 - QA Domain)
  # ============================================================================

  # Performance regression detection
  - repo: local
    hooks:
      - id: performance-regression
        name: Performance Regression Check
        entry: scripts/validate-performance-regression.sh
        language: script
        pass_filenames: false
        files: ^backend/(app|tests)/.*\.py$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 23: Dependency Version Guard (Session 085 - ARCHITECT Domain)
  # ============================================================================

  # Dependency version protection - blocks critical dep changes without override
  - repo: local
    hooks:
      - id: dependency-versions
        name: Dependency Version Guard
        entry: scripts/validate-dependency-versions.sh
        language: script
        pass_filenames: false
        files: ^(frontend/package\.json|frontend/package-lock\.json|backend/requirements\.txt)$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 24: D&D Hooks (Parallel) - Run after all standard linting
  # ============================================================================

  # Combined D&D-themed hooks running in parallel:
  #   - Couatl Killer: snake_case query params (frontend)
  #   - Beholder Bane: SQLAlchemy anti-magic (backend)
  #   - Gorgon's Gaze: snake_case enum values (frontend)
  # These specialized checks catch issues normal linters miss.
  - repo: local
    hooks:
      - id: dnd-hooks
        name: D&D Hooks (Couatl Killer + Beholder Bane + Gorgon's Gaze)
        entry: scripts/dnd-hooks-parallel.sh
        language: script
        pass_filenames: false
        files: ^(frontend/src/.*\.(ts|tsx)|backend/.*\.py)$
        stages: [pre-commit]

  # ============================================================================
  # PHASE 25: Modron March - Frontend-Backend Type Contract Enforcement
  # ============================================================================

  # Named after D&D Modrons - lawful constructs from Mechanus who enforce cosmic
  # order. Validates that frontend TypeScript types match backend Pydantic schemas.
  # Prevents the snake_case/camelCase type drift that causes runtime crashes.
  - repo: local
    hooks:
      - id: modron-march
        name: Modron March (Type Contract Enforcement)
        entry: scripts/modron-march.sh
        language: script
        pass_filenames: false
        files: ^(backend/app/schemas/.*\.py|backend/app/api/routes/.*\.py|frontend/src/types/.*\.ts|frontend/src/hooks/use.*\.ts|frontend/src/lib/api\.ts|frontend/src/lib/hooks\.ts)$
        stages: [pre-commit]

  # ============================================================================
  # Configuration
  # ============================================================================

ci:
  autofix_commit_msg: 'chore(pre-commit): auto-fix pre-commit hooks'
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: 'chore(pre-commit): auto-update hooks'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
