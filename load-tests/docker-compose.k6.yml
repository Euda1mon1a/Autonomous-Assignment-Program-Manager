
services:
  k6:
    image: grafana/k6:latest
    container_name: residency-scheduler-k6
    networks:
      - residency-scheduler-network
    volumes:
      # Mount the load-tests directory
      - ./:/load-tests
      # Mount results directory for output
      - ./results:/results
    environment:
      # API configuration
      - API_BASE_URL=${API_BASE_URL:-http://backend:8000}
      - TEST_ENV=${TEST_ENV:-docker}
      
      # Test configuration
      - K6_OUT=${K6_OUT:-json=/results/test-results.json}
      - K6_WEB_DASHBOARD=${K6_WEB_DASHBOARD:-true}
      - K6_WEB_DASHBOARD_EXPORT=${K6_WEB_DASHBOARD_EXPORT:-/results/html-report.html}
      
      # Optional: InfluxDB output for Grafana
      # - K6_OUT=influxdb=http://influxdb:8086/k6
      
      # Optional: Prometheus Remote Write
      # - K6_PROMETHEUS_RW_SERVER_URL=http://prometheus:9090/api/v1/write
      
    # Command can be overridden when running specific tests
    # Default: run a smoke test
    command: run /load-tests/scenarios/smoke-test.js
    
    # Only run when explicitly started
    profiles:
      - load-testing
    
    depends_on:
      - backend
    
  # Optional: InfluxDB for time-series metrics storage
  influxdb:
    image: influxdb:2.7-alpine
    container_name: k6-influxdb
    networks:
      - residency-scheduler-network
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=residency-scheduler
      - DOCKER_INFLUXDB_INIT_BUCKET=k6
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=k6-admin-token
    volumes:
      - influxdb-data:/var/lib/influxdb2
    profiles:
      - load-testing-metrics
  
  # Optional: Grafana for visualization
  grafana-k6:
    image: grafana/grafana:latest
    container_name: k6-grafana
    networks:
      - residency-scheduler-network
    ports:
      - "3001:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SERVER_ROOT_URL=http://localhost:3001
    volumes:
      - grafana-k6-data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards
    depends_on:
      - influxdb
    profiles:
      - load-testing-metrics

networks:
  residency-scheduler-network:
    external: true
    # Note: This assumes the main docker-compose network exists
    # If not, create it with: docker network create residency-scheduler-network
    # Or set external: false to create it automatically

volumes:
  influxdb-data:
    driver: local
  grafana-k6-data:
    driver: local
