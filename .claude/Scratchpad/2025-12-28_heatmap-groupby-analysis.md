# Heatmap group_by Bug Analysis

> **Generated:** 2025-12-28
> **Agent:** COORD_FRONTEND (a611c98)
> **Issue:** Backend rejects "Daily" and "Weekly" group_by values

---

## Summary

**Root Cause:** Frontend/backend contract mismatch for `group_by` parameter.

| Source | Valid Values | Default |
|--------|--------------|---------|
| Frontend type | `'day' \| 'week' \| 'person' \| 'rotation'` | `'day'` |
| Backend validation | `'person' \| 'rotation'` | `'person'` |

When users select "Daily" or "Weekly" grouping (or use the default), the API returns 400: `"group_by must be 'person' or 'rotation'"`.

---

## Affected Files

### Frontend
- `frontend/src/features/heatmap/types.ts:57` - Type definition with 4 options
- `frontend/src/features/heatmap/HeatmapControls.tsx:83,123` - Default value
- `frontend/src/app/heatmap/page.tsx:21` - Page default

### Backend
- `backend/app/api/routes/visualization.py:59-61` - Explicit validation
- `backend/app/schemas/visualization.py:20-22` - Schema description

---

## Recommended Fix: Option A (Frontend Change)

The backend is correct; frontend should be updated to match.

### Changes Required:

**1. `frontend/src/features/heatmap/types.ts`**
```typescript
// Line 57: Remove day/week
export type HeatmapGroupBy = 'person' | 'rotation';

// Lines 203-208: Update labels
export const GROUP_BY_LABELS: Record<HeatmapGroupBy, string> = {
  person: 'By Person',
  rotation: 'By Rotation',
};
```

**2. `frontend/src/app/heatmap/page.tsx`**
```typescript
// Line 21: Change default
group_by: 'person',  // was 'day'
```

**3. `frontend/src/features/heatmap/HeatmapControls.tsx`**
```typescript
// Line 83: Change clear default
group_by: 'person',  // was 'day'
```

---

## Alternative: Option B (Backend Change)

If "Daily"/"Weekly" grouping is a desired feature:
1. Update backend validation to accept `day` and `week`
2. Implement time-based aggregation in `CachedHeatmapService`
3. Add tests for new grouping options

**Recommendation:** Option A is lower risk and can be done immediately.

---

## User Decision Required

Does the heatmap need "Daily" and "Weekly" time-based grouping, or should those options be removed from the UI?

---

*Report generated by COORD_FRONTEND agent during autonomous session.*
